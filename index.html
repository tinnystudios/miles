<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<meta name="description" content="Track medical trip mileage for tax purposes">
<title>MileLog</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230f172a'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white' font-family='sans-serif' font-weight='bold'>M</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230f172a'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white' font-family='sans-serif' font-weight='bold'>M</text></svg>">
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@500&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body, #root { height: 100%; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: #f1f5f9;
    overscroll-behavior: none;
    -webkit-font-smoothing: antialiased;
  }
  input, select, textarea, button { font-family: 'DM Sans', sans-serif; }
  input:focus, select:focus, textarea:focus { border-color: #3b82f6 !important; outline: none; }
  input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.5; }
  input[type="time"]::-webkit-calendar-picker-indicator { opacity: 0.5; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
// Register service worker for PWA install + offline
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

const { useState, useEffect, useMemo, createElement: h } = React;

const APP_KEY = "milelog_v2";
const load = () => { try { const r = localStorage.getItem(APP_KEY); return r ? JSON.parse(r) : { trips: [], addresses: [] }; } catch { return { trips: [], addresses: [] }; } };
const save = (d) => localStorage.setItem(APP_KEY, JSON.stringify(d));
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
const fmtDate = (d) => new Date(d).toLocaleDateString("en-AU", { weekday: "short", day: "numeric", month: "short", year: "numeric" });
const fmtTime = (t) => { if (!t) return ""; const [h,m] = t.split(":"); const hr = parseInt(h); const ampm = hr >= 12 ? "PM" : "AM"; return ((hr % 12) || 12) + ":" + m + " " + ampm; };
const pad = (n) => String(n).padStart(2, "0");
const todayStr = () => { const d = new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
const nowTime = () => { const d = new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}`; };

const weekNum = (d) => {
  const date = new Date(d); date.setHours(0,0,0,0);
  date.setDate(date.getDate() + 3 - ((date.getDay() + 6) % 7));
  const w1 = new Date(date.getFullYear(), 0, 4);
  return { y: date.getFullYear(), w: 1 + Math.round(((date - w1) / 864e5 - 3 + ((w1.getDay() + 6) % 7)) / 7) };
};

const vehicles = ["My Car", "Hospital Car", "Other"];

// SVG icons
const Icon = (paths, vb = "0 0 24 24") => (props) => h("svg", { width: props?.s || 18, height: props?.s || 18, viewBox: vb, fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", style: props?.style }, ...paths.map(p => typeof p === "string" ? h("path", { d: p }) : p));

const IconPlus = Icon([h("line", { x1: 12, y1: 5, x2: 12, y2: 19, strokeWidth: 2.5 }), h("line", { x1: 5, y1: 12, x2: 19, y2: 12, strokeWidth: 2.5 })]);
const IconDL = Icon(["M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4", h("polyline", { points: "7 10 12 15 17 10" }), h("line", { x1: 12, y1: 15, x2: 12, y2: 3 })]);
const IconTrash = Icon([h("polyline", { points: "3 6 5 6 21 6" }), "M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6", "M10 11v6", "M14 11v6", "M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"]);
const IconEdit = Icon(["M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7", "M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"]);
const IconBookmark = Icon(["M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"]);
const IconMap = Icon(["M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z", h("circle", { cx: 12, cy: 10, r: 3 })]);
const IconX = Icon([h("line", { x1: 18, y1: 6, x2: 6, y2: 18, strokeWidth: 2.5 }), h("line", { x1: 6, y1: 6, x2: 18, y2: 18, strokeWidth: 2.5 })]);
const IconCar = Icon(["M5 17h14v-5l-2-6H7L5 12v5z", h("circle", { cx: 7.5, cy: 17, r: 2 }), h("circle", { cx: 16.5, cy: 17, r: 2 })]);
const IconChev = (props) => h("svg", { width: 16, height: 16, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", style: { transform: props.up ? "rotate(180deg)" : "none", transition: "transform 0.2s" } }, h("polyline", { points: "6 9 12 15 18 9" }));

// ─── Address Suggestions ───
function AddrSuggestions({ addresses, field, show, onPick }) {
  if (!show || !addresses.length) return null;
  return h("div", { style: { position: "absolute", top: "100%", left: 0, right: 0, background: "#fff", borderRadius: 12, boxShadow: "0 8px 24px rgba(0,0,0,0.12)", zIndex: 50, maxHeight: 200, overflowY: "auto", marginTop: 4, border: "1px solid #e2e8f0" } },
    addresses.map(a => h("button", { key: a.id, onClick: () => onPick(a), style: { display: "flex", flexDirection: "column", width: "100%", padding: "10px 14px", background: "none", border: "none", borderBottom: "1px solid #f1f5f9", textAlign: "left", cursor: "pointer", gap: 2 } },
      h("span", { style: { fontWeight: 600, color: "#1e293b", fontSize: 14 } }, a.label),
      h("span", { style: { fontSize: 12, color: "#64748b" } }, a.address)
    ))
  );
}

// ─── Trip Form ───
function TripForm({ addresses, trip, onSave, onCancel }) {
  const [form, setForm] = useState(trip ? {
    from: trip.from || "", to: trip.to || "",
    date: trip.date || todayStr(),
    startTime: trip.startTime || nowTime(),
    endTime: trip.endTime || "",
    distance: trip.distance || "", vehicle: trip.vehicle || "My Car",
    purpose: trip.purpose || "", notes: trip.notes || ""
  } : { from: "", to: "", date: todayStr(), startTime: nowTime(), endTime: "", distance: "", vehicle: "My Car", purpose: "", notes: "" });

  const [showFrom, setShowFrom] = useState(false);
  const [showTo, setShowTo] = useState(false);

  const set = (k, v) => setForm(p => ({ ...p, [k]: v }));
  const valid = form.distance && form.date && form.startTime;

  const handleSave = () => {
    if (!valid) return;
    onSave({ ...(trip || {}), ...form });
  };

  const label = (text) => h("label", { style: { display: "block", fontSize: 13, fontWeight: 600, color: "#475569", marginBottom: 6, letterSpacing: "0.2px" } }, text);
  const input = (props) => h("input", { style: { width: "100%", padding: "12px 14px", background: "#fff", border: "1.5px solid #e2e8f0", borderRadius: 12, fontSize: 15, color: "#0f172a" }, ...props });

  return h("div", { style: { animation: "slideUp 0.25s ease", paddingBottom: 40 } },
    h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 } },
      h("h2", { style: { fontSize: 22, fontWeight: 700, color: "#0f172a" } }, trip ? "Edit Trip" : "New Trip"),
      h("button", { onClick: onCancel, style: { background: "#f1f5f9", border: "none", borderRadius: 10, width: 36, height: 36, display: "flex", alignItems: "center", justifyContent: "center", color: "#64748b", cursor: "pointer" } }, h(IconX))
    ),
    // From
    h("div", { style: { marginBottom: 16 } },
      label("From"),
      h("div", { style: { position: "relative" } },
        input({ value: form.from, onChange: e => set("from", e.target.value), onFocus: () => setShowFrom(true), onBlur: () => setTimeout(() => setShowFrom(false), 200), placeholder: "Start location" }),
        addresses.length > 0 && h("button", { onClick: () => setShowFrom(!showFrom), style: { position: "absolute", right: 10, top: "50%", transform: "translateY(-50%)", background: "none", border: "none", color: "#94a3b8", cursor: "pointer", padding: 4 } }, h(IconBookmark)),
        h(AddrSuggestions, { addresses, show: showFrom, onPick: a => { set("from", a.label + " — " + a.address); setShowFrom(false); } })
      )
    ),
    // To
    h("div", { style: { marginBottom: 16 } },
      label("To"),
      h("div", { style: { position: "relative" } },
        input({ value: form.to, onChange: e => set("to", e.target.value), onFocus: () => setShowTo(true), onBlur: () => setTimeout(() => setShowTo(false), 200), placeholder: "Destination" }),
        addresses.length > 0 && h("button", { onClick: () => setShowTo(!showTo), style: { position: "absolute", right: 10, top: "50%", transform: "translateY(-50%)", background: "none", border: "none", color: "#94a3b8", cursor: "pointer", padding: 4 } }, h(IconBookmark)),
        h(AddrSuggestions, { addresses, show: showTo, onPick: a => { set("to", a.label + " — " + a.address); setShowTo(false); } })
      )
    ),
    // Date
    h("div", { style: { marginBottom: 16 } },
      label("Date *"),
      input({ type: "date", value: form.date, onChange: e => set("date", e.target.value) })
    ),
    // Start/End time
    h("div", { style: { display: "flex", gap: 12, marginBottom: 16 } },
      h("div", { style: { flex: 1 } }, label("Start Time *"), input({ type: "time", value: form.startTime, onChange: e => set("startTime", e.target.value) })),
      h("div", { style: { flex: 1 } }, label("End Time"), input({ type: "time", value: form.endTime, onChange: e => set("endTime", e.target.value) }))
    ),
    // Distance / Vehicle
    h("div", { style: { display: "flex", gap: 12, marginBottom: 16 } },
      h("div", { style: { flex: 1 } }, label("Distance (km) *"), input({ type: "number", inputMode: "decimal", step: "0.1", value: form.distance, onChange: e => set("distance", e.target.value), placeholder: "0.0" })),
      h("div", { style: { flex: 1 } }, label("Vehicle"),
        h("select", { value: form.vehicle, onChange: e => set("vehicle", e.target.value), style: { width: "100%", padding: "12px 14px", background: "#fff", border: "1.5px solid #e2e8f0", borderRadius: 12, fontSize: 15, color: "#0f172a" } },
          vehicles.map(v => h("option", { key: v, value: v }, v))
        )
      )
    ),
    // Purpose
    h("div", { style: { marginBottom: 16 } }, label("Purpose"), input({ value: form.purpose, onChange: e => set("purpose", e.target.value), placeholder: "e.g. Home visit, patient consult" })),
    // Notes
    h("div", { style: { marginBottom: 16 } }, label("Notes"),
      h("textarea", { value: form.notes, onChange: e => set("notes", e.target.value), placeholder: "Optional notes...", style: { width: "100%", padding: "12px 14px", background: "#fff", border: "1.5px solid #e2e8f0", borderRadius: 12, fontSize: 15, color: "#0f172a", minHeight: 60, resize: "vertical", fontFamily: "inherit" } })
    ),
    // Save
    h("button", { onClick: handleSave, disabled: !valid, style: { width: "100%", padding: "14px", background: "linear-gradient(145deg, #3b82f6, #2563eb)", border: "none", borderRadius: 14, color: "#fff", fontSize: 15, fontWeight: 700, cursor: "pointer", marginTop: 8, opacity: valid ? 1 : 0.5, transition: "opacity 0.15s" } }, trip ? "Update Trip" : "Save Trip")
  );
}

// ─── Address Manager ───
function AddressManager({ addresses, onAdd, onRemove, onClose }) {
  const [label, setLabel] = useState("");
  const [address, setAddress] = useState("");
  const handleAdd = () => { if (!label.trim() || !address.trim()) return; onAdd({ label: label.trim(), address: address.trim() }); setLabel(""); setAddress(""); };
  const lbl = (text) => h("label", { style: { display: "block", fontSize: 13, fontWeight: 600, color: "#475569", marginBottom: 6 } }, text);
  const inp = (props) => h("input", { style: { width: "100%", padding: "12px 14px", background: "#fff", border: "1.5px solid #e2e8f0", borderRadius: 12, fontSize: 15, color: "#0f172a" }, ...props });

  return h("div", { style: { animation: "slideUp 0.25s ease", paddingBottom: 40 } },
    h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 } },
      h("h2", { style: { fontSize: 22, fontWeight: 700, color: "#0f172a" } }, "Saved Addresses"),
      h("button", { onClick: onClose, style: { background: "#f1f5f9", border: "none", borderRadius: 10, width: 36, height: 36, display: "flex", alignItems: "center", justifyContent: "center", color: "#64748b", cursor: "pointer" } }, h(IconX))
    ),
    h("p", { style: { fontSize: 14, color: "#64748b", margin: "0 0 20px" } }, "Save frequently visited locations for quick entry."),
    h("div", { style: { marginBottom: 16 } }, lbl("Label"), inp({ value: label, onChange: e => setLabel(e.target.value), placeholder: "e.g. Royal Melbourne Hospital" })),
    h("div", { style: { marginBottom: 16 } }, lbl("Address"), inp({ value: address, onChange: e => setAddress(e.target.value), placeholder: "e.g. 300 Grattan St, Parkville VIC 3050" })),
    h("button", { onClick: handleAdd, disabled: !label || !address, style: { width: "100%", padding: "14px", background: "linear-gradient(145deg, #3b82f6, #2563eb)", border: "none", borderRadius: 14, color: "#fff", fontSize: 15, fontWeight: 700, cursor: "pointer", marginBottom: 28, opacity: label && address ? 1 : 0.5 } }, "Add Address"),
    addresses.length === 0
      ? h("div", { style: { textAlign: "center", padding: "40px 20px", color: "#94a3b8" } }, h(IconMap), h("p", { style: { marginTop: 12, fontSize: 14 } }, "No saved addresses yet"))
      : addresses.map(a => h("div", { key: a.id, style: { display: "flex", justifyContent: "space-between", alignItems: "center", background: "#fff", borderRadius: 12, padding: "14px 16px", marginBottom: 8, boxShadow: "0 1px 3px rgba(0,0,0,0.06)" } },
          h("div", null,
            h("div", { style: { fontWeight: 600, color: "#1e293b", fontSize: 15 } }, a.label),
            h("div", { style: { color: "#64748b", fontSize: 13, marginTop: 2 } }, a.address)
          ),
          h("button", { onClick: () => onRemove(a.id), style: { background: "none", border: "none", padding: "6px 10px", color: "#ef4444", cursor: "pointer", flexShrink: 0 } }, h(IconTrash))
        ))
  );
}

// ─── Main App ───
function App() {
  const [data, setData] = useState(load);
  const [view, setView] = useState("list");
  const [editId, setEditId] = useState(null);
  const [filter, setFilter] = useState("month");
  const [expanded, setExpanded] = useState(null);
  const [confirmDel, setConfirmDel] = useState(null);

  useEffect(() => { save(data); }, [data]);

  const addTrip = (t) => { setData(p => ({ ...p, trips: [{ ...t, id: uid() }, ...p.trips] })); setView("list"); };
  const updateTrip = (t) => { setData(p => ({ ...p, trips: p.trips.map(x => x.id === t.id ? t : x) })); setView("list"); setEditId(null); };
  const deleteTrip = (id) => { setData(p => ({ ...p, trips: p.trips.filter(x => x.id !== id) })); setConfirmDel(null); setExpanded(null); };
  const addAddr = (a) => { setData(p => ({ ...p, addresses: [...p.addresses, { ...a, id: uid() }] })); };
  const removeAddr = (id) => { setData(p => ({ ...p, addresses: p.addresses.filter(x => x.id !== id) })); };

  const filtered = useMemo(() => {
    const now = new Date();
    return data.trips.filter(t => {
      const d = new Date(t.date + "T00:00:00");
      if (filter === "week") { const tw = weekNum(now), dw = weekNum(d); return tw.y === dw.y && tw.w === dw.w; }
      if (filter === "month") return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      if (filter === "year") return d.getFullYear() === now.getFullYear();
      return true;
    });
  }, [data.trips, filter]);

  const totalKm = filtered.reduce((s, t) => s + (parseFloat(t.distance) || 0), 0);
  const grouped = useMemo(() => {
    const g = {};
    filtered.forEach(t => { const k = t.date; if (!g[k]) g[k] = []; g[k].push(t); });
    return Object.entries(g).sort((a, b) => b[0].localeCompare(a[0]));
  }, [filtered]);

  const exportCSV = () => {
    const q = (v) => '"' + String(v||"").replace(/"/g,'""') + '"';
    const hdr = ["Date","Start Time","End Time","From","To","Distance (km)","Vehicle","Purpose","Notes"];
    const rows = filtered.map(t => [q(fmtDate(t.date + "T00:00:00")), q(fmtTime(t.startTime)), q(fmtTime(t.endTime)), q(t.from), q(t.to), q(t.distance), q(t.vehicle), q(t.purpose), q(t.notes)]);
    const csv = [hdr.join(","), ...rows.map(r => r.join(","))].join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = `milelog-${filter}-${new Date().toISOString().slice(0,10)}.csv`; a.click();
    URL.revokeObjectURL(url);
  };

  return h("div", { style: { maxWidth: 480, margin: "0 auto", minHeight: "100vh", background: "#f1f5f9", position: "relative" } },
    // Header
    h("header", { style: { background: "linear-gradient(145deg, #0f172a 0%, #1e3a5f 100%)", padding: "20px 20px 16px", paddingTop: "max(20px, env(safe-area-inset-top, 20px))", color: "#fff", position: "sticky", top: 0, zIndex: 100 } },
      h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12 } },
        h("div", null,
          h("h1", { style: { fontSize: 26, fontWeight: 700, letterSpacing: "-0.5px", margin: 0, lineHeight: 1 } }, "MileLog"),
          h("p", { style: { fontSize: 13, fontWeight: 400, opacity: 0.6, marginTop: 2, letterSpacing: "0.5px", textTransform: "uppercase" } }, "Trip Tracker")
        ),
        h("button", { onClick: () => setView(view === "addresses" ? "list" : "addresses"), style: { background: "rgba(255,255,255,0.12)", border: "none", borderRadius: 10, padding: "8px 10px", color: "#fff", cursor: "pointer", display: "flex", alignItems: "center" } }, h(IconBookmark))
      ),
      view === "list" && h(React.Fragment, null,
        h("div", { style: { display: "flex", alignItems: "center", justifyContent: "center", background: "rgba(255,255,255,0.08)", borderRadius: 14, padding: "14px 20px", marginBottom: 14 } },
          h("div", { style: { display: "flex", alignItems: "baseline", gap: 6, flex: 1, justifyContent: "center" } },
            h("span", { style: { fontSize: 28, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", letterSpacing: "-1px" } }, totalKm.toFixed(1)),
            h("span", { style: { fontSize: 14, opacity: 0.5, fontWeight: 500 } }, "km")
          ),
          h("div", { style: { width: 1, height: 32, background: "rgba(255,255,255,0.15)", margin: "0 8px" } }),
          h("div", { style: { display: "flex", alignItems: "baseline", gap: 6, flex: 1, justifyContent: "center" } },
            h("span", { style: { fontSize: 28, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", letterSpacing: "-1px" } }, filtered.length),
            h("span", { style: { fontSize: 14, opacity: 0.5, fontWeight: 500 } }, "trips")
          )
        ),
        h("div", { style: { display: "flex", gap: 6 } },
          ["week","month","year","all"].map(f =>
            h("button", { key: f, onClick: () => setFilter(f), style: { flex: 1, padding: "8px 0", background: filter === f ? "#fff" : "rgba(255,255,255,0.08)", border: "none", borderRadius: 10, color: filter === f ? "#0f172a" : "rgba(255,255,255,0.5)", fontSize: 13, fontWeight: 600, cursor: "pointer", transition: "all 0.15s" } }, f === "all" ? "All" : f.charAt(0).toUpperCase() + f.slice(1))
          )
        )
      )
    ),

    // Main content
    h("main", { style: { padding: "12px 16px 24px" } },
      view === "list" && h(React.Fragment, null,
        grouped.length === 0
          ? h("div", { style: { textAlign: "center", padding: "60px 20px", color: "#94a3b8", animation: "fadeIn 0.3s ease" } },
              h(IconMap), h("p", { style: { margin: "12px 0 4px", fontWeight: 600, color: "#334155" } }, "No trips yet"),
              h("p", { style: { color: "#94a3b8", fontSize: 14 } }, "Tap + to log your first trip")
            )
          : grouped.map(([date, trips]) =>
              h("div", { key: date, style: { marginBottom: 16, animation: "slideUp 0.3s ease" } },
                h("div", { style: { fontSize: 13, fontWeight: 600, color: "#64748b", padding: "8px 4px 6px", letterSpacing: "0.3px" } }, fmtDate(trips[0].date + "T00:00:00")),
                trips.map(trip =>
                  h("div", { key: trip.id, style: { background: "#fff", borderRadius: 14, marginBottom: 8, overflow: "hidden", boxShadow: "0 1px 3px rgba(0,0,0,0.06)" } },
                    h("div", { onClick: () => setExpanded(expanded === trip.id ? null : trip.id), style: { display: "flex", justifyContent: "space-between", alignItems: "center", padding: "14px 16px", cursor: "pointer" } },
                      h("div", { style: { display: "flex", gap: 12, alignItems: "center", flex: 1, minWidth: 0 } },
                        h("div", { style: { display: "flex", flexDirection: "column", alignItems: "center", gap: 2, flexShrink: 0 } },
                          h("span", { style: { width: 8, height: 8, borderRadius: "50%", background: "#3b82f6" } }),
                          h("span", { style: { width: 2, height: 14, background: "#e2e8f0" } }),
                          h("span", { style: { width: 8, height: 8, borderRadius: "50%", background: "#10b981" } })
                        ),
                        h("div", { style: { minWidth: 0 } },
                          h("div", { style: { fontSize: 14, fontWeight: 600, color: "#1e293b", whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis", maxWidth: 200 } }, trip.from || "—"),
                          h("div", { style: { fontSize: 13, color: "#64748b", whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis", maxWidth: 200, marginTop: 2 } }, trip.to || "—")
                        )
                      ),
                      h("div", { style: { display: "flex", flexDirection: "column", alignItems: "flex-end", gap: 2, flexShrink: 0, marginLeft: 12 } },
                        h("div", { style: { fontSize: 15, fontWeight: 700, color: "#0f172a", fontFamily: "'JetBrains Mono', monospace" } }, trip.distance + " km"),
                        h("div", { style: { fontSize: 12, color: "#94a3b8" } }, fmtTime(trip.startTime)),
                        h(IconChev, { up: expanded === trip.id })
                      )
                    ),
                    expanded === trip.id && h("div", { style: { borderTop: "1px solid #f1f5f9", padding: "12px 16px", animation: "fadeIn 0.15s ease" } },
                      h("div", { style: { display: "flex", flexDirection: "column", gap: 6, fontSize: 13, color: "#475569", marginBottom: 12 } },
                        trip.endTime && h("span", null, "End: " + fmtTime(trip.endTime)),
                        trip.vehicle && h("span", { style: { display: "inline-flex", alignItems: "center", gap: 4, background: "#f1f5f9", padding: "3px 10px", borderRadius: 8, width: "fit-content", fontWeight: 500 } }, h(IconCar), " " + trip.vehicle),
                        trip.purpose && h("span", null, "Purpose: " + trip.purpose),
                        trip.notes && h("span", null, "Notes: " + trip.notes)
                      ),
                      h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center" } },
                        h("button", { onClick: () => { setEditId(trip.id); setView("edit"); }, style: { background: "none", border: "none", padding: "6px 10px", fontSize: 13, fontWeight: 600, color: "#3b82f6", cursor: "pointer", display: "flex", alignItems: "center", gap: 5, borderRadius: 8 } }, h(IconEdit), " Edit"),
                        confirmDel === trip.id
                          ? h("div", { style: { display: "flex", gap: 8, alignItems: "center" } },
                              h("span", { style: { fontSize: 13, color: "#ef4444" } }, "Delete?"),
                              h("button", { onClick: () => deleteTrip(trip.id), style: { background: "none", border: "none", padding: "6px 10px", fontSize: 13, fontWeight: 600, color: "#ef4444", cursor: "pointer" } }, "Yes"),
                              h("button", { onClick: () => setConfirmDel(null), style: { background: "none", border: "none", padding: "6px 10px", fontSize: 13, fontWeight: 600, color: "#3b82f6", cursor: "pointer" } }, "No")
                            )
                          : h("button", { onClick: () => setConfirmDel(trip.id), style: { background: "none", border: "none", padding: "6px 10px", fontSize: 13, fontWeight: 600, color: "#ef4444", cursor: "pointer", display: "flex", alignItems: "center", gap: 5, borderRadius: 8 } }, h(IconTrash), " Delete")
                      )
                    )
                  )
                )
              )
            ),
        filtered.length > 0 && h("button", { onClick: exportCSV, style: { display: "flex", alignItems: "center", justifyContent: "center", gap: 8, width: "100%", padding: "14px", background: "#fff", border: "2px dashed #cbd5e1", borderRadius: 14, color: "#475569", fontSize: 14, fontWeight: 600, cursor: "pointer", marginTop: 8 } }, h(IconDL), " Export " + (filter !== "all" ? "This " + filter.charAt(0).toUpperCase() + filter.slice(1) : "All") + " to CSV"),
        h("div", { style: { height: 100 } })
      ),

      view === "add" && h(TripForm, { addresses: data.addresses, onSave: addTrip, onCancel: () => setView("list") }),
      view === "edit" && h(TripForm, { addresses: data.addresses, trip: data.trips.find(t => t.id === editId), onSave: updateTrip, onCancel: () => { setView("list"); setEditId(null); } }),
      view === "addresses" && h(AddressManager, { addresses: data.addresses, onAdd: addAddr, onRemove: removeAddr, onClose: () => setView("list") })
    ),

    // FAB
    view === "list" && h("button", { onClick: () => setView("add"), style: { position: "fixed", bottom: 28, right: "max(16px, calc(50% - 224px))", width: 56, height: 56, borderRadius: "50%", background: "linear-gradient(145deg, #3b82f6, #2563eb)", border: "none", color: "#fff", display: "flex", alignItems: "center", justifyContent: "center", boxShadow: "0 4px 20px rgba(37,99,235,0.4)", cursor: "pointer", zIndex: 200 } }, h(IconPlus, { s: 22 }))
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(h(App));
</script>
</body>
</html>
